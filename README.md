# Домашняя работа "Реализация кластера postgreSQL с помощью patroni"

Цель работы - создать стенд с отказоустойчивым кластером Postgresql построенным с помощью patroni. Хранение конфигурации кластера в etcd, входящие подключения к БД организуются с помощью haproxy.

Данный репозиторий содержит:

- Манифесты terraform для создания инфраструктуры проекта:
  - 3 воркера Postgresql, на которых настроен кластер etcd и кластер patroni.
  - 1 ВМ с HAProxy, принимает входящие клиентские подключения к БД
  - и, наконец, виртуалка с установленным ансиблем, чтоб развернуть вышеупомянутые роли. Выступает так же в роли SSH Jump host проекта

- Роли ansible для приведения виртуальных машин в проекте в требуемое состояние.

При разворачивании стенда создаются ВМ с параметрами:
- 2 CPU;
- 2 GB RAM;
- 10 GB диск;
- операционная система Almalinux 8;

Для разворачивания стенда необходимо:

1. Заполнить значение переменных cloud_id, folder_id и iam-token в файле **variables.tf**.

2. Инициализировать рабочую среду Terraform:

```
$ terraform init
```
В результате будет установлен провайдер для подключения к облаку Яндекс.

3. Запустить разворачивание стенда:
```
$ terraform apply
```
В выходных данных будут показаны все внешние и внутренние ip адреса.


Заходим на ip haproxy из браузера, чтоб наглядно видеть смену лидера кластера patroni:
```
http://{external_ip_address_haproxy}:7000
```
Напрямую в БД можно подключиться:
```
psql -Upostgres -h{external_ip_address_haproxy} -p5000
(пароль postgres)
```

Можно создать тестовую базу, наполнить её данными. Если через веб-панель или подключаясь по ssh выключать воркеры db0, db1 или db2, то можно увидеть, что в haproxy меняется активный лидер и подключение к БД восстанавливается. Данные БД при этом не теряются благодаря репликации.